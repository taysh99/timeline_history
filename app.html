<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>History Timeline (VN + CN) ‚Äî Historical Maps</title>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <style>
    :root {
      /* Light theme */
      --bg:#f3f4f6;
      --card:#fff;
      --text:#0f172a;
      --muted:#64748b;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.08);
      --radius:16px;
      --accent:#3b82f6;
      --accent-hover:#2563eb;
      --success:#10b981;
      --warning:#f59e0b;
      --error:#ef4444;
      --gradient-primary:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
      --gradient-secondary:linear-gradient(135deg,#f093fb 0%,#f5576c 100%);
    }

    [data-theme="dark"] {
      /* Dark theme */
      --bg:#0f172a;
      --card:#1e293b;
      --text:#f1f5f9;
      --muted:#94a3b8;
      --border:#334155;
      --shadow:0 10px 30px rgba(0,0,0,.3);
      --accent:#60a5fa;
      --accent-hover:#3b82f6;
    }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:var(--bg);color:var(--text);transition:background-color 0.3s ease,color 0.3s ease;line-height:1.6}
    .container{max-width:1200px;margin:0 auto;padding:18px}
    .header{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap;padding:20px;border-radius:16px;margin-bottom:20px;background:linear-gradient(135deg,rgba(59,130,246,0.1) 0%,rgba(118,75,162,0.1) 100%)}
    h1{margin:0;letter-spacing:-.02em;font-size:2rem;font-weight:700;line-height:1.2}
    h2{margin:0;font-size:1.5rem;font-weight:600}
    h3{margin:0;font-size:1.25rem;font-weight:600;margin-bottom:8px}
    .sub{color:var(--muted);font-size:14px;margin-top:6px}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);box-shadow:var(--shadow);padding:14px;transition:transform 0.2s ease,box-shadow 0.2s ease}
    .card:hover{transform:translateY(-2px);box-shadow:0 15px 40px rgba(0,0,0,.1)}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px}
    @media (min-width:768px){.grid{grid-template-columns:1fr 1fr}}
    .controls{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media (min-width:768px){.controls{grid-template-columns:1.2fr 1fr;align-items:stretch}}
    @media (max-width:767px){
      .container{padding:12px}
      .header{flex-direction:column;gap:16px;text-align:center}
      .header h1{font-size:24px}
      .controls{grid-template-columns:1fr}
      .chipRow{justify-content:center}
      .kpiRow{grid-template-columns:1fr;gap:8px}
      .kpi{min-width:auto}
      .split{grid-template-columns:1fr}
      .modal{max-width:95vw;max-height:90vh;overflow-y:auto}
    }
    .label{font-weight:700;font-size:13px}
    .muted{color:var(--muted)}
    .chipRow{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--card);font-size:12px;font-weight:700;user-select:none;cursor:pointer;min-height:32px;min-width:32px;justify-content:center;color:var(--text)}
    .chip.on{background:#eef2ff;border-color:#c7d2fe}
    .chip.badge{cursor:pointer;background:var(--muted);color:var(--card)}

    [data-theme="dark"] .chip{background:#334155;color:#f1f5f9}
    [data-theme="dark"] .chip.on{background:#1e293b;border-color:#3b82f6}
    [data-theme="dark"] .chip.badge{background:#64748b;color:#f1f5f9}
    .pill{display:inline-block;padding:4px 10px;border-radius:999px;background:#eef2ff;font-size:12px;font-weight:800;border:1px solid #c7d2fe}
    [data-theme="dark"] .pill{background:#1e293b;border-color:#3b82f6;color:#f1f5f9}
    .input{width:100%;box-sizing:border-box;border:1px solid var(--border);border-radius:12px;padding:10px 12px;font-size:14px;outline:none;background:var(--card);color:var(--text);transition:border-color 0.2s ease,box-shadow 0.2s ease}
    .input:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(59,130,246,.35)}
    .btn{border:1px solid var(--border);background:var(--card);border-radius:12px;padding:9px 12px;font-weight:800;cursor:pointer;color:var(--text);transition:background-color 0.2s ease,border-color 0.2s ease}
    .btn:hover{background:var(--muted);opacity:0.8}
    .section{margin-top:12px}
    .sectionTitle{font-weight:900;margin-bottom:6px;color:var(--text)}
    .item{padding:6px 0;cursor:pointer}
    .item:hover{text-decoration:underline}
    .split{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media (min-width:980px){.split{grid-template-columns:1fr 1fr}}
    .compareBox{border:1px dashed #cbd5e1;border-radius:14px;padding:12px;background:#fbfdff;margin-top:10px}
    [data-theme="dark"] .compareBox{background:#1e293b;border-color:#475569}
    .compareTitle{display:flex;justify-content:space-between;align-items:baseline;gap:8px;flex-wrap:wrap}
    .kpiRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .kpi{border:1px solid var(--border);background:var(--card);border-radius:14px;padding:10px 12px;min-width:180px}
    .kpi .num{font-size:18px;font-weight:1000;color:var(--text)}
    .kpi .cap{color:var(--muted);font-size:12px;margin-top:2px}
    .searchWrap{position:relative}
    .searchDrop{position:absolute;left:0;right:0;top:44px;background:#fff;border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);max-height:320px;overflow:auto;z-index:1000}
    .searchItem{padding:10px 12px;border-bottom:1px solid #f1f5f9;cursor:pointer;transition:background-color 0.2s ease,transform 0.1s ease}
    .searchItem:hover{background:#f8fafc;transform:translateX(4px)}
    .searchItem:last-child{border-bottom:none}
    .searchName{font-weight:900}
    .searchMeta{color:var(--muted);font-size:12px;margin-top:3px}

    .loading{display:flex;align-items:center;justify-content:center;padding:40px;gap:12px;color:var(--muted)}
    .spinner{width:20px;height:20px;border:2px solid var(--border);border-top:2px solid var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

    .mapSkeleton{background:linear-gradient(90deg,#f0f0f0 25%,#e0e0e0 50%,#f0f0f0 75%);background-size:200% 100%;animation:pulse 1.5s infinite;width:100%;min-height:280px;max-height:400px;aspect-ratio:16/10;border-radius:16px;border:1px solid var(--border);margin-top:10px}
    [data-theme="dark"] .mapSkeleton{background:linear-gradient(90deg,#374151 25%,#4b5563 50%,#374151 75%);background-size:200% 100%}

    /* Floating Action Button for Theme Toggle */
    .themeToggleFab{position:fixed;bottom:24px;right:24px;width:56px;height:56px;border-radius:50%;background:var(--accent);color:#fff;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:24px;box-shadow:0 4px 12px rgba(0,0,0,.3);z-index:1000;transition:all 0.3s ease;outline:none}
    .themeToggleFab:hover{transform:scale(1.1);box-shadow:0 6px 20px rgba(0,0,0,.4);background:var(--accent-hover)}
    .themeToggleFab:active{transform:scale(0.95)}

    @media (max-width:767px){
      .themeToggleFab{bottom:16px;right:16px;width:48px;height:48px;font-size:20px}
    }

    /* Responsive map sizing */
    @media (max-width: 768px) {
      .mapImage {
        min-height: 200px !important;
        max-height: 300px !important;
      }
    }

    .zoomControls {
      position: absolute;
      top: 10px;
      right: 10px;
      display: flex;
      gap: 8px;
      background: rgba(0,0,0,0.7);
      padding: 8px;
      border-radius: 8px;
      backdrop-filter: blur(4px);
    }

    [data-theme="dark"] .zoomControls {
      background: rgba(255,255,255,0.1);
    }

    [data-theme="dark"] .themeToggleFab{background:#60a5fa}
    [data-theme="dark"] .themeToggleFab:hover{background:#3b82f6}
    .modalBg{position:fixed;inset:0;background:rgba(0,0,0,.6);display:flex;align-items:center;justify-content:center;padding:16px;z-index:2000;backdrop-filter:blur(4px);transition:opacity 0.3s ease}
    .modal{background:var(--card);border-radius:16px;max-width:900px;width:100%;padding:24px;position:relative;box-shadow:0 20px 60px rgba(0,0,0,.3);border:1px solid var(--border);animation:modalSlideIn 0.3s ease-out}
    .modalClose{position:absolute;top:12px;right:12px;width:32px;height:32px;border-radius:50%;background:var(--muted);color:var(--text);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:background-color 0.2s ease}
    .modalClose:hover{background:var(--border)}

    @keyframes modalSlideIn {
      from { opacity:0; transform:translateY(-20px) scale(0.95) }
      to { opacity:1; transform:translateY(0) scale(1) }
    }
    .modal h3{margin:0 0 8px}
    .hr{height:1px;background:#eef2f7;margin:12px 0}
    .warn{color:#b91c1c;font-weight:800}
    code{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;font-size:12px}
  </style>
</head>
<body>
<div id="root"></div>

<script type="text/babel" data-presets="env,react">
function safeArr(x){ return Array.isArray(x) ? x : []; }
function safeStr(x){ return (typeof x === "string") ? x : ""; }
function hasTodo(p){ return p && p.notes === "PLACEHOLDER_TODO"; }

function getContentItems(p){
  const c = p && p.content ? p.content : {};
  return { events: safeArr(c.events), figures: safeArr(c.figures), achievements: safeArr(c.achievements) };
}

function periodMatchesYear(p, year){
  return p && Number.isInteger(p.startYear) && Number.isInteger(p.endYear) && year >= p.startYear && year <= p.endYear;
}

function periodHasGrades(p, selectedGrades){
  const g = safeArr(p && p.grades);
  if (selectedGrades.size === 0) return true;
  for (const x of g) if (selectedGrades.has(x)) return true;
  return false;
}

function mkSearchText(p){
  const c = getContentItems(p);
  const parts = [
    safeStr(p.name),
    safeStr(p.summary),
    safeArr(p.topics).join(" "),
    safeArr(p.grades).join(" "),
    c.events.map(x => safeStr(x.title)+" "+safeStr(x.detail)).join(" "),
    c.figures.map(x => safeStr(x.title)+" "+safeStr(x.detail)).join(" "),
    c.achievements.map(x => safeStr(x.title)+" "+safeStr(x.detail)).join(" "),
  ];
  return parts.join(" ").toLowerCase();
}

function scoreMatch(p, q){
  const name = safeStr(p.name).toLowerCase();
  const summary = safeStr(p.summary).toLowerCase();
  let s = 0;
  if (name.includes(q)) s += 50;
  if (summary.includes(q)) s += 20;
  const text = p.__searchText || "";
  if (text.includes(q)) s += 10;

  // Bonus cho figures - nh√¢n v·∫≠t l·ªãch s·ª≠
  const c = getContentItems(p);
  for (const fig of c.figures) {
    const figText = (safeStr(fig.title) + " " + safeStr(fig.detail)).toLowerCase();
    if (figText.includes(q)) {
      s += 30; // TƒÉng ƒëi·ªÉm cao cho figures
      break; // Ch·ªâ c·∫ßn 1 figure match l√† ƒë·ªß
    }
  }

  if (!hasTodo(p)) s += 5;
  return s;
}

function pickHighlights(periods){
  const out = [];
  for (const p of periods){
    const c = getContentItems(p);
    for (const e of c.events) if (out.length < 3) out.push("S·ª± ki·ªán: " + e.title);
    for (const f of c.figures) if (out.length < 3) out.push("Nh√¢n v·∫≠t: " + f.title);
    for (const a of c.achievements) if (out.length < 3) out.push("Th√†nh t·ª±u: " + a.title);
    if (out.length >= 3) break;
  }
  return out;
}

function buildCompareNotes(vnPeriods, cnPeriods){
  const vnNames = vnPeriods.map(p => p.name).join(", ") || "‚Äî";
  const cnNames = cnPeriods.map(p => p.name).join(", ") || "‚Äî";
  const vnHL = pickHighlights(vnPeriods);
  const cnHL = pickHighlights(cnPeriods);
  return {
    vnNames, cnNames,
    vnHL: vnHL.length ? vnHL : ["(Ch∆∞a c√≥ m·ª•c n·ªïi b·∫≠t trong dataset cho nƒÉm n√†y)"],
    cnHL: cnHL.length ? cnHL : ["(Ch∆∞a c√≥ m·ª•c n·ªïi b·∫≠t trong dataset cho nƒÉm n√†y)"],
  };
}

function GradeChips({ selectedGrades, setSelectedGrades }){
  const grades = ["L6","L7","L8","L9","L10","L11","L12"];
  function toggle(g){
    const next = new Set(Array.from(selectedGrades));
    if (next.has(g)) next.delete(g); else next.add(g);
    setSelectedGrades(next);
  }
  function setAll(){ setSelectedGrades(new Set()); }
  return (
    <div>
      <div className="compareTitle">
        <div className="label">Filter theo l·ªõp</div>
        <button className="btn" onClick={setAll} title="B·ªè ch·ªçn ƒë·ªÉ hi·ªán t·∫•t c·∫£">Hi·ªán t·∫•t c·∫£</button>
      </div>
      <div className="chipRow">
        {grades.map(g => (
          <div key={g} className={"chip " + (selectedGrades.has(g) ? "on" : "")} onClick={() => toggle(g)}>{g}</div>
        ))}
        <div className="chip badge">{selectedGrades.size === 0 ? "All grades" : ("Selected: " + selectedGrades.size)}</div>
      </div>
    </div>
  );
}

function getMatchingFigures(p, query) {
  const c = getContentItems(p);
  const matchingFigs = [];
  for (const fig of c.figures) {
    const figText = (safeStr(fig.title) + " " + safeStr(fig.detail)).toLowerCase();
    if (figText.includes(query)) {
      matchingFigs.push(fig.title);
    }
  }
  return matchingFigs;
}

function SearchBox({ allPeriods, onJump, hidePlaceholders, selectedGrades }){
  const [q, setQ] = React.useState("");
  const [open, setOpen] = React.useState(false);

  const results = React.useMemo(() => {
    const query = q.trim().toLowerCase();
    if (query.length < 2) return [];
    const base = allPeriods
      .filter(p => (hidePlaceholders ? !hasTodo(p) : true))
      .filter(p => periodHasGrades(p, selectedGrades));
    const scored = [];
    for (const p of base){
      const s = scoreMatch(p, query);
      if (s > 0) {
        scored.push({
          p,
          s,
          matchingFigures: getMatchingFigures(p, query)
        });
      }
    }
    scored.sort((a,b) => b.s - a.s);
    return scored.slice(0, 10);
  }, [q, allPeriods, hidePlaceholders, selectedGrades]);

  function choose(p){
    setQ(""); setOpen(false); onJump(p);
  }

  return (
    <div className="searchWrap">
          <div className="label">üîç T√¨m ki·∫øm (giai ƒëo·∫°n / s·ª± ki·ªán / nh√¢n v·∫≠t l·ªãch s·ª≠)</div>
      <input className="input" value={q} placeholder='V√≠ d·ª•: "H√†n T√≠n", "Nguy·ªÖn Du", "Kh·ªïng T·ª≠", "Tr·∫ßn H∆∞ng ƒê·∫°o"...'
        onChange={(e) => { setQ(e.target.value); setOpen(true); }}
        onFocus={() => setOpen(true)}
        onBlur={() => setTimeout(() => setOpen(false), 120)}
      />
      {open && results.length > 0 && (
        <div className="searchDrop">
          {results.map(({ p, matchingFigures }) => (
            <div key={p.id} className="searchItem" onMouseDown={() => choose(p)}>
              <div className="searchName">{p.country === "VN" ? "üáªüá≥" : "üá®üá≥"} {p.name} <span className="muted">({p.startYear}‚Äì{p.endYear})</span></div>
              <div className="searchMeta">{safeArr(p.grades).join(", ")} ‚Ä¢ {safeArr(p.topics).slice(0,4).join(", ")}</div>
              {matchingFigures.length > 0 && (
                <div className="searchMeta" style={{ color: "#2563eb", fontWeight: "600" }}>
                  üë§ Nh√¢n v·∫≠t: {matchingFigures.slice(0, 2).join(", ")}{matchingFigures.length > 2 ? "..." : ""}
                </div>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

function CountryPanel({ title, periods, onOpenDetail }){
  return (
    <div className="panel">
      <h2 style={{ margin:"0 0 8px" }}>{title}</h2>
      {periods.length === 0 ? (<div className="muted">Kh√¥ng c√≥ giai ƒëo·∫°n ph√π h·ª£p filter / nƒÉm n√†y.</div>) : null}
      {periods.map(p => {
        const c = getContentItems(p);
        return (
          <div key={p.id} style={{ marginTop: 12 }}>
            <div className="pill">{p.name} ({p.startYear}‚Äì{p.endYear})</div>
            <div className="muted" style={{ marginTop: 6 }}>{p.summary}</div>
            <div className="chipRow" style={{ marginTop: 8 }}>
              {safeArr(p.grades).map(g => <div className="chip badge" key={p.id+"_g_"+g}>{g}</div>)}
              {safeArr(p.topics).slice(0,4).map(t => <div className="chip badge" key={p.id+"_t_"+t}>{t}</div>)}
              {p.map && p.map.src ? <div className="chip badge">üó∫Ô∏è map</div> : null}
            </div>

            <div className="section">
              <div className="sectionTitle">S·ª± ki·ªán</div>
              {safeArr(c.events).length === 0 ? <div className="muted">‚Äî</div> : null}
              {safeArr(c.events).slice(0,4).map((e,i) => {
                const eventDetail = e.detail + (e.location ? ` (·ªü ${e.location})` : '') +
                                  (e.actors && e.actors.length > 0 ? ` - ${e.actors.join(', ')}` : '') +
                                  (e.year ? ` (${e.year})` : '');
                return (
                  <div className="item" key={p.id+"_e_"+i} onClick={() => onOpenDetail(e.title, eventDetail, p)}>
                    ‚Ä¢ {e.title}
                    {e.location && <span className="muted" style={{fontSize:"11px", marginLeft:"4px"}}>üìç{e.location}</span>}
                  </div>
                );
              })}
            </div>

            <div className="section">
              <div className="sectionTitle">Nh√¢n v·∫≠t</div>
              {safeArr(c.figures).length === 0 ? <div className="muted">‚Äî</div> : null}
              {safeArr(c.figures).slice(0,4).map((f,i) => (
                <div className="item" key={p.id+"_f_"+i} onClick={() => onOpenDetail(f.title, f.detail, p)}>‚Ä¢ {f.title}</div>
              ))}
            </div>

            <div className="section">
              <div className="sectionTitle">Th√†nh t·ª±u</div>
              {safeArr(c.achievements).length === 0 ? <div className="muted">‚Äî</div> : null}
              {safeArr(c.achievements).slice(0,4).map((a,i) => (
                <div className="item" key={p.id+"_a_"+i} onClick={() => onOpenDetail(a.title, a.detail, p)}>‚Ä¢ {a.title}</div>
              ))}
            </div>

            <div className="hr"></div>
          </div>
        );
      })}
    </div>
  );
}

function CompareHighlight({ year, vnPeriods, cnPeriods }){
  function sumCounts(periods){
    let e=0,f=0,a=0;
    for (const p of periods){
      const c = getContentItems(p);
      e += safeArr(c.events).length;
      f += safeArr(c.figures).length;
      a += safeArr(c.achievements).length;
    }
    return { e,f,a };
  }
  const vnC = sumCounts(vnPeriods);
  const cnC = sumCounts(cnPeriods);
  const notes = buildCompareNotes(vnPeriods, cnPeriods);

  return (
    <div className="card" style={{ marginTop: 12 }}>
      <div className="compareTitle">
        <div>
          <div style={{ fontWeight: 1000, fontSize: 18 }}>‚ú® Compare Highlight</div>
          <div className="muted" style={{ marginTop: 4 }}>NƒÉm {year} ‚Äî so s√°nh nhanh d·ª±a tr√™n dataset</div>
        </div>
        <div className="chip badge">Tip: click map ƒë·ªÉ ph√≥ng to</div>
      </div>

      <div className="kpiRow">
        <div className="kpi"><div className="num">üáªüá≥ {vnPeriods.length}</div><div className="cap">Giai ƒëo·∫°n active</div></div>
        <div className="kpi"><div className="num">üá®üá≥ {cnPeriods.length}</div><div className="cap">Giai ƒëo·∫°n active</div></div>
        <div className="kpi"><div className="num">{vnC.e + cnC.e}</div><div className="cap">T·ªïng s·ª± ki·ªán (2 b√™n)</div></div>
      </div>

      <div className="compareBox">
        <div className="split">
          <div>
            <div style={{ fontWeight: 1000 }}>üáªüá≥ Vi·ªát Nam</div>
            <div className="muted" style={{ marginTop: 6 }}><b>Giai ƒëo·∫°n:</b> {notes.vnNames}</div>
            <div className="muted" style={{ marginTop: 6 }}><b>Counts:</b> {vnC.e} s·ª± ki·ªán ‚Ä¢ {vnC.f} nh√¢n v·∫≠t ‚Ä¢ {vnC.a} th√†nh t·ª±u</div>
            <div style={{ marginTop: 10 }}>
              <div className="sectionTitle">ƒêi·ªÉm n·ªïi b·∫≠t</div>
              {notes.vnHL.map((x,i) => <div key={"vnhl_"+i} className="muted">‚Ä¢ {x}</div>)}
            </div>
          </div>

          <div>
            <div style={{ fontWeight: 1000 }}>üá®üá≥ Trung Qu·ªëc</div>
            <div className="muted" style={{ marginTop: 6 }}><b>Giai ƒëo·∫°n:</b> {notes.cnNames}</div>
            <div className="muted" style={{ marginTop: 6 }}><b>Counts:</b> {cnC.e} s·ª± ki·ªán ‚Ä¢ {cnC.f} nh√¢n v·∫≠t ‚Ä¢ {cnC.a} th√†nh t·ª±u</div>
            <div style={{ marginTop: 10 }}>
              <div className="sectionTitle">ƒêi·ªÉm n·ªïi b·∫≠t</div>
              {notes.cnHL.map((x,i) => <div key={"cnhl_"+i} className="muted">‚Ä¢ {x}</div>)}
            </div>
          </div>
        </div>
      </div>
    </div>
  );
}

function pickMapCandidates(periods){
  const out = [];
  for (const p of periods){
    if (p && p.map && p.map.src) out.push(p);
  }
  return out;
}

function HistoricalMapPanel({ year, vnPeriods, cnPeriods }){
  const vnCands = pickMapCandidates(vnPeriods);
  const cnCands = pickMapCandidates(cnPeriods);

  const [vnIdx, setVnIdx] = React.useState(0);
  const [cnIdx, setCnIdx] = React.useState(0);
  const [zoom, setZoom] = React.useState(null);
  const [zoomScale, setZoomScale] = React.useState(1);

  React.useEffect(() => { setVnIdx(0); }, [vnCands.length, year]);
  React.useEffect(() => { setCnIdx(0); }, [cnCands.length, year]);

  function MapCard({ label, cands, idx, setIdx, flag }){
    const p = cands.length ? cands[Math.min(idx, cands.length - 1)] : (null);
    const m = p && p.map ? p.map : null;
    const [imageLoading, setImageLoading] = React.useState(true);
    const [imageError, setImageError] = React.useState(false);

    return (
      <div className="panel">
        <div style={{ display:"flex", justifyContent:"space-between", gap:8, flexWrap:"wrap", alignItems:"baseline" }}>
          <h2 style={{ margin: 0 }}>{flag} {label}</h2>
          <div className="muted" style={{ fontSize: 12 }}>NƒÉm {year}</div>
        </div>

        {!p ? (
          <div className="muted" style={{ marginTop: 10 }}>
            NƒÉm n√†y ch∆∞a c√≥ map (ho·∫∑c period kh√¥ng set <code>map.src</code>).
          </div>
        ) : (
          <div style={{ marginTop: 10 }}>
            <div style={{ display:"flex", justifyContent:"space-between", alignItems:"center", gap:10, flexWrap:"wrap" }}>
              <div className="pill">{p.name} ({p.startYear}‚Äì{p.endYear})</div>
              {cands.length > 1 ? (
                <div className="chipRow" style={{ marginTop: 0 }}>
                  <button className="btn" onClick={() => setIdx((idx - 1 + cands.length) % cands.length)}>‚óÄ</button>
                  <div className="chip badge">{idx+1}/{cands.length}</div>
                  <button className="btn" onClick={() => setIdx((idx + 1) % cands.length)}>‚ñ∂</button>
                </div>
              ) : null}
            </div>

            {m && m.src ? (
              <div style={{position:"relative"}}>
                {imageLoading && <div className="mapSkeleton"></div>}
                <img
                  className="mapImage"
                  src={m.src}
                  alt={m.caption || (p.name + " map")}
                  style={{
                    width:"100%",
                    minHeight:"280px",
                    maxHeight:"400px",
                    aspectRatio:"16/10",
                    objectFit:"contain",
                    borderRadius:"16px",
                    border:"1px solid var(--border)",
                    marginTop:"10px",
                    cursor:"zoom-in",
                    backgroundColor:"var(--card)",
                    boxShadow:"var(--shadow)",
                    transition:"transform 0.2s ease, box-shadow 0.2s ease",
                    display: imageLoading ? "none" : "block"
                  }}
                  onLoad={() => setImageLoading(false)}
                  onError={() => {
                    setImageLoading(false);
                    setImageError(true);
                  }}
                  onMouseEnter={(e) => !imageError && (e.target.style.transform = "scale(1.02)")}
                  onMouseLeave={(e) => !imageError && (e.target.style.transform = "scale(1)")}
                  onClick={() => !imageError && (setZoom({ flag, period:p, map:m }), setZoomScale(1))}
                />
                {imageError && (
                  <div style={{
                    width:"100%",
                    minHeight:"280px",
                    maxHeight:"400px",
                    aspectRatio:"16/10",
                    borderRadius:"16px",
                    border:"1px solid var(--error)",
                    marginTop:"10px",
                    backgroundColor:"var(--card)",
                    display:"flex",
                    alignItems:"center",
                    justifyContent:"center",
                    color:"var(--error)",
                    fontSize:"14px"
                  }}>
                    ‚ùå Kh√¥ng th·ªÉ t·∫£i b·∫£n ƒë·ªì
                  </div>
                )}
              </div>
            ) : (
              <div className="muted" style={{ marginTop: 10 }}>Ch∆∞a c√≥ map.src cho giai ƒëo·∫°n n√†y.</div>
            )}

            {m ? (
              <div className="muted" style={{ marginTop: 8, fontSize: 12 }}>
                <b>{m.caption || "B·∫£n ƒë·ªì th·ªùi k√¨"}</b>
                {m.attribution ? <div>Ngu·ªìn: {m.attribution}</div> : null}
                {m.license ? <div>License: {m.license}</div> : null}
              </div>
            ) : null}
          </div>
        )}
      </div>
    );
  }

  return (
    <div style={{ marginTop: 12 }}>
      <div className="card">
        <div className="compareTitle">
          <div>
            <div style={{ fontWeight: 1000, fontSize: 18 }}>üó∫Ô∏è B·∫£n ƒë·ªì theo th·ªùi k√¨</div>
            <div className="muted" style={{ marginTop: 4 }}>
              M·ªói giai ƒëo·∫°n c√≥ m·ªôt ·∫£nh b·∫£n ƒë·ªì ri√™ng (set trong JSON: <code>map.src</code>). Click ·∫£nh ƒë·ªÉ ph√≥ng to.
            </div>
          </div>
          <div className="chip badge">Thay ·∫£nh ·ªü assets/maps/</div>
        </div>
      </div>

      <div className="grid" style={{ marginTop: 12 }}>
        <MapCard label="Vi·ªát Nam" cands={vnCands} idx={vnIdx} setIdx={setVnIdx} flag="üáªüá≥" />
        <MapCard label="Trung Qu·ªëc" cands={cnCands} idx={cnIdx} setIdx={setCnIdx} flag="üá®üá≥" />
      </div>

      {zoom ? (
        <div className="modalBg" onClick={() => setZoom(null)}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <h3>{zoom.flag} {zoom.period.name} ({zoom.period.startYear}‚Äì{zoom.period.endYear})</h3>
            <div className="muted" style={{ marginBottom: 10 }}>{zoom.map.caption || ""}</div>

            <div style={{position:"relative", marginBottom:"10px"}}>
              <img
                src={zoom.map.src}
                alt={zoom.map.caption || "map"}
                style={{
                  width:"100%",
                  maxHeight:"70vh",
                  objectFit:"contain",
                  borderRadius:"14px",
                  border:"1px solid var(--border)",
                  transform:`scale(${zoomScale})`,
                  transition:"transform 0.3s ease",
                  cursor: zoomScale > 1 ? "zoom-out" : "zoom-in"
                }}
                onClick={() => setZoomScale(zoomScale > 1 ? 1 : 2)}
              />

              {/* Zoom Controls */}
              <div className="zoomControls">
                <button
                  className="btn"
                  style={{padding:"4px 8px", fontSize:"12px", minWidth:"auto"}}
                  onClick={() => setZoomScale(Math.max(0.5, zoomScale - 0.25))}
                  disabled={zoomScale <= 0.5}
                  title="Zoom out"
                >
                  üîç-
                </button>
                <button
                  className="btn"
                  style={{padding:"4px 8px", fontSize:"12px", minWidth:"auto"}}
                  onClick={() => setZoomScale(1)}
                  title="Reset zoom"
                >
                  100%
                </button>
                <button
                  className="btn"
                  style={{padding:"4px 8px", fontSize:"12px", minWidth:"auto"}}
                  onClick={() => setZoomScale(Math.min(3, zoomScale + 0.25))}
                  disabled={zoomScale >= 3}
                  title="Zoom in"
                >
                  üîç+
                </button>
              </div>
            </div>

            <div className="muted" style={{ marginTop: 10, fontSize: 12 }}>
              {zoom.map.attribution ? <div>Ngu·ªìn: {zoom.map.attribution}</div> : null}
              {zoom.map.license ? <div>License: {zoom.map.license}</div> : null}
              <div>Zoom: {Math.round(zoomScale * 100)}%</div>
            </div>

            <div className="hr"></div>
            <button className="btn" onClick={() => setZoom(null)}>ƒê√≥ng</button>
          </div>
        </div>
      ) : null}
    </div>
  );
}

async function loadJson(path) {
  const res = await fetch(path);
  if (!res.ok) throw new Error("Kh√¥ng ƒë·ªçc ƒë∆∞·ª£c: " + path + " (HTTP " + res.status + ")");
  return await res.json();
}

function App(){
  const [year, setYear] = React.useState(1103);
  const [vn, setVn] = React.useState([]);
  const [cn, setCn] = React.useState([]);
  const [err, setErr] = React.useState("");
  const [modal, setModal] = React.useState(null);
  const [theme, setTheme] = React.useState('light');
  const [loading, setLoading] = React.useState(true);

  const [hideTodos, setHideTodos] = React.useState(true);
  const [selectedGrades, setSelectedGrades] = React.useState(new Set());

  React.useEffect(() => {
    (async () => {
      setLoading(true);
      try{
        const vnData = await loadJson("./data/vietnam/periods.json");
        const cnData = await loadJson("./data/china/periods.json");
        for (const p of vnData) p.__searchText = mkSearchText(p);
        for (const p of cnData) p.__searchText = mkSearchText(p);
        setVn(vnData); setCn(cnData);
      } catch(e){ setErr(String(e && e.message ? e.message : e)); }
      finally { setLoading(false); }
    })();
  }, []);

  // Theme initialization and management
  React.useEffect(() => {
    const savedTheme = localStorage.getItem('theme');
    const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const initialTheme = savedTheme || (systemPrefersDark ? 'dark' : 'light');
    setTheme(initialTheme);
    document.documentElement.setAttribute('data-theme', initialTheme);
  }, []);

  const toggleTheme = React.useCallback(() => {
    const newTheme = theme === 'light' ? 'dark' : 'light';
    setTheme(newTheme);
    document.documentElement.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
  }, [theme]);


  const allPeriods = React.useMemo(() => ([]).concat(vn, cn), [vn, cn]);

  const vnPeriods = React.useMemo(() => {
    return vn.filter(p => (hideTodos ? !hasTodo(p) : true))
             .filter(p => periodHasGrades(p, selectedGrades))
             .filter(p => periodMatchesYear(p, year));
  }, [vn, year, hideTodos, selectedGrades]);

  const cnPeriods = React.useMemo(() => {
    return cn.filter(p => (hideTodos ? !hasTodo(p) : true))
             .filter(p => periodHasGrades(p, selectedGrades))
             .filter(p => periodMatchesYear(p, year));
  }, [cn, year, hideTodos, selectedGrades]);

  function openDetail(title, detail, period){ setModal({ title, detail, period }); }

  function jumpToPeriod(p){
    const y = Number.isInteger(p.startYear) ? p.startYear : year;
    setYear(y);
    setModal({ title: (p.country === "VN" ? "üáªüá≥ " : "üá®üá≥ ") + p.name, detail: p.summary, period: p });
  }

  if (loading) {
    return (
      <div className="container">
        <div className="loading">
          <div className="spinner"></div>
          <span>ƒêang t·∫£i d·ªØ li·ªáu l·ªãch s·ª≠...</span>
        </div>
      </div>
    );
  }

  return (
    <div className="container">
      <div className="header">
        <div>
          <h1>History Timeline (VN + CN)</h1>
          <div className="sub">Historical maps ‚Ä¢ Search ‚Ä¢ Filter l·ªõp ‚Ä¢ Compare highlight</div>
        </div>
        <div className="chipRow">
          <div className="chip badge">Run: <code>npx serve .</code></div>
          <div className="chip badge">Open: <code>/app.html</code></div>
        </div>
      </div>

      <div className="controls">
        <div className="card">
          <div className="compareTitle">
            <div>
              <div className="label">NƒÉm: {year}</div>
              <div className="muted" style={{ fontSize: 12, marginTop: 4 }}>K√©o ƒë·ªÉ xem giai ƒëo·∫°n cover nƒÉm ƒë√≥</div>
            </div>
            <label className="chip" style={{ cursor:"pointer" }}>
              <input type="checkbox" checked={hideTodos} onChange={(e) => setHideTodos(e.target.checked)} style={{ transform:"translateY(1px)" }}/>
              ·∫®n PLACEHOLDER_TODO
            </label>
          </div>

          <input type="range" min="-700" max="2025" value={year}
            onChange={(e) => setYear(parseInt(e.target.value, 10))}
            style={{ width:"100%", marginTop: 10 }}
          />

          {err ? (<div className="warn" style={{ marginTop: 10 }}>{err}</div>) : null}
          <div className="hr"></div>
          <GradeChips selectedGrades={selectedGrades} setSelectedGrades={setSelectedGrades} />
        </div>

        <div className="card">
          <SearchBox allPeriods={allPeriods} onJump={jumpToPeriod} hidePlaceholders={hideTodos} selectedGrades={selectedGrades}/>
          <div className="hr"></div>
          <div className="label">Quick actions</div>
          <div className="row" style={{ marginTop: 10 }}>
            <button className="btn" onClick={() => setYear(40)}>NƒÉm 40</button>
            <button className="btn" onClick={() => setYear(938)}>NƒÉm 938</button>
            <button className="btn" onClick={() => setYear(1550)}>NƒÉm 1550</button>
            <button className="btn" onClick={() => setYear(200)}>NƒÉm 200</button>
          </div>
          <div className="muted" style={{ marginTop: 10, fontSize: 12 }}>
            B·∫£n ƒë·ªì theo th·ªùi k√¨ l·∫•y t·ª´ <code>map.src</code> trong dataset. B·∫°n ch·ªâ c·∫ßn thay ·∫£nh trong <code>assets/maps/</code>.
          </div>
        </div>
      </div>

      <HistoricalMapPanel year={year} vnPeriods={vnPeriods} cnPeriods={cnPeriods} />
      <CompareHighlight year={year} vnPeriods={vnPeriods} cnPeriods={cnPeriods} />

      <div className="grid" style={{ marginTop: 12 }}>
        <CountryPanel title="üáªüá≥ Vi·ªát Nam" periods={vnPeriods} onOpenDetail={openDetail} />
        <CountryPanel title="üá®üá≥ Trung Qu·ªëc" periods={cnPeriods} onOpenDetail={openDetail} />
      </div>

      {modal ? (
        <div className="modalBg" onClick={() => setModal(null)}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <button className="modalClose" onClick={() => setModal(null)} aria-label="Close modal">√ó</button>
            <h3 style={{marginTop:0,paddingRight:"40px"}}>{modal.title}</h3>
            <div className="muted" style={{ marginBottom: 10 }}>
              {modal.period ? (<span>{modal.period.country} ‚Ä¢ {modal.period.name} ({modal.period.startYear}‚Äì{modal.period.endYear})</span>) : null}
            </div>
            <div style={{ lineHeight:"22px" }}>{modal.detail}</div>
            <div className="hr"></div>
            <button className="btn" onClick={() => setModal(null)}>ƒê√≥ng</button>
          </div>
        </div>
      ) : null}

      {/* Floating Theme Toggle Button */}
      <button className="themeToggleFab" onClick={toggleTheme} aria-label="Toggle theme" title={theme === 'light' ? 'Chuy·ªÉn sang Dark Mode' : 'Chuy·ªÉn sang Light Mode'}>
        {theme === 'light' ? 'üåô' : '‚òÄÔ∏è'}
      </button>
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
</body>
</html>
